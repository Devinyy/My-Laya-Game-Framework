{
  "code": "import { LwgAni3D, LwgEvent, LwgTools } from \"../../Lwg/Lwg\";\r\nimport { GameData } from \"../Control/GameData\";\r\nimport { GameEnum } from \"../Control/GameEnum\";\r\nimport { GameEvent } from \"../Control/GameEvent\";\r\nimport { GameRes } from \"../Control/GameRes\";\r\nexport class SceneBase {\r\n    constructor(scene) {\r\n        this.roadAddTime = 200;\r\n        this.roadDestoryDistance = 80;\r\n        this.roadDataArr = [];\r\n        this.redBase = [1, 0.45, 0.35];\r\n        this.yellowBase = [1, 0.70, 0.17];\r\n        this.blueBase = [0.3, 0.6, 1];\r\n        this.redCount = 0;\r\n        this.yellowCount = 0;\r\n        this.blueCount = 0;\r\n        this.mileageRoad = 0;\r\n        this.heightRoad = 0;\r\n        this.mileageTotal = 0;\r\n        this._mileageCur = 0;\r\n        this.scene = scene;\r\n        Laya.stage.addChild(this.scene);\r\n        this.camaraPoint = this.scene.getChildByName('CameraPoint');\r\n        this.mainCamara = this.camaraPoint.getChildByName('Main Camera');\r\n        if (Laya.Browser.pixelRatio >= 16 / 9) {\r\n            this.mainCamara.fieldOfView += 5;\r\n        }\r\n        const mainCamaraP = this.mainCamara.transform.position;\r\n        this.mainCamaraFP = new Laya.Vector3(mainCamaraP.x, mainCamaraP.y, mainCamaraP.z);\r\n        this.directionalLight = this.camaraPoint.getChildByName('Directional Light');\r\n        this.roadParent = new Laya.Sprite3D;\r\n        this.roadParent.name = 'roadParent';\r\n        this.scene.addChild(this.roadParent);\r\n        this.marginParent = new Laya.Sprite3D;\r\n        this.marginParent.name = 'marginParent';\r\n        this.scene.addChild(this.marginParent);\r\n    }\r\n    get endRoadData() {\r\n        return this._endRoadData;\r\n    }\r\n    set endRoadData(val) {\r\n        this.redCount = 0;\r\n        this.yellowCount = 0;\r\n        this.blueCount = 0;\r\n        this._endRoadData = val;\r\n    }\r\n    get mileageCur() {\r\n        return this._mileageCur;\r\n    }\r\n    set mileageCur(val) {\r\n        this._mileageCur = val;\r\n        if (GameData.Level.mode === GameEnum.LevelMode.common) {\r\n            if (this._mileageCur > this.mileageTotal) {\r\n                this._mileageCur = this.mileageTotal;\r\n            }\r\n        }\r\n        LwgEvent.notify(GameEvent.updateLvSchedule, [this._mileageCur / this.mileageTotal, this._mileageCur]);\r\n    }\r\n    showbase() {\r\n        Laya.timer.clearAll(this);\r\n        this.mileageRoad = 0;\r\n        this.heightRoad = 0;\r\n        this.mileageTotal = 0;\r\n        this.mileageCur = 0;\r\n        this.roadIndex = 0;\r\n        this.marginIndex = -2;\r\n        this.colorIndex = 1;\r\n        this.start();\r\n        this.RoadAdd();\r\n        this.RoadDestory();\r\n        LwgEvent.register(GameEvent.addMileageCur, this, (num) => {\r\n            this.mileageCur += num;\r\n        });\r\n    }\r\n    start() {\r\n        LwgTools.Node.destroyAllChildren(this.marginParent);\r\n        LwgTools.Node.destroyAllChildren(this.roadParent);\r\n        for (let i = 0; i < 4; i++) {\r\n            this.createRoad();\r\n        }\r\n        this.createMargin();\r\n    }\r\n    createMargin() {\r\n        if (GameData.Level.mode === GameEnum.LevelMode.common) {\r\n            this.endMargin = GameRes.Prefab3D.marginC.instance.clone();\r\n        }\r\n        else {\r\n            this.endMargin = GameRes.Prefab3D.marginE.instance.clone();\r\n        }\r\n        this.marginParent.addChild(this.endMargin);\r\n        this.endMargin.transform.position = new Laya.Vector3(0, 0, this.marginIndex * 200);\r\n        this.marginIndex++;\r\n    }\r\n    setEndData() {\r\n        this.endRoadData = this.roadDataArr[this.roadIndex];\r\n    }\r\n    createRoad() {\r\n        this.setEndData();\r\n        if (!this.endRoadData) {\r\n            return;\r\n        }\r\n        var add = () => {\r\n            this.roadParent.addChild(this.endRoad);\r\n            this.endRoad.transform.position = new Laya.Vector3(0, this.heightRoad, this.mileageRoad);\r\n            this.mileageRoad += this.endRoadData.length;\r\n            this.heightRoad += this.endRoadData.height;\r\n            this.endRoad.heightRoad = this.heightRoad;\r\n            this.roadIndex++;\r\n        };\r\n        if (this.endRoadData.name === 'Road_999' || this.endRoadData.name === 'Road_888' || this.endRoadData.name === 'Road_997') {\r\n            this.endRoad = GameRes.Prefab3D[this.endRoadData.name].instance.clone();\r\n            if (this.endRoadData.name === 'Road_888') {\r\n                this.changeRodeColor(this.endRoad);\r\n            }\r\n            add();\r\n        }\r\n        else {\r\n            const childDataArr = GameData.RoadsMsg.getChildDataArrByRoadName(this.endRoadData.name);\r\n            if (childDataArr) {\r\n                this.endRoad = new Laya.Sprite3D();\r\n                this.endRoad.name = this.endRoadData.name;\r\n                add();\r\n                for (let index = 0; index < childDataArr.length; index++) {\r\n                    const childData = childDataArr[index];\r\n                    let res = this.resCorresponding(childData.name);\r\n                    if (!res) {\r\n                        console.log(this.endRoadData.name, '不存在资源:', childData.name);\r\n                        return false;\r\n                    }\r\n                    let child = res.clone();\r\n                    this.endRoad.addChild(child);\r\n                    child.transform.localPosition = new Laya.Vector3(childData.data.localPositionX, childData.data.localPositionY, childData.data.localPositionZ);\r\n                    child.transform.localScale = new Laya.Vector3(childData.data.localScaleX, childData.data.localScaleY, childData.data.localScaleZ);\r\n                    child.transform.localRotationEuler = new Laya.Vector3(childData.data.localRotationEulerX, childData.data.localRotationEulerY, childData.data.localRotationEulerZ);\r\n                    child.active = childData.active;\r\n                    if (child.name.substr(0, 7) === 'KeyFood') {\r\n                        child.transform.localPositionY += 2;\r\n                    }\r\n                    this.changeRodeColor(child);\r\n                    this.changeDoorColor(child);\r\n                }\r\n                this.setBubbleColorIndex();\r\n                for (let j = 0; j < this.endRoad.numChildren; j++) {\r\n                    const element = this.endRoad.getChildAt(j);\r\n                    this.changeColor(element);\r\n                }\r\n            }\r\n            else {\r\n                console.log(this.endRoadData.name, '没有数据', this.endRoadData, '索引值：', this.roadIndex);\r\n                Laya.timer.clearAll(this);\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    }\r\n    resCorresponding(name) {\r\n        let res;\r\n        if (name.substr(0, 6) === 'paopao') {\r\n            const name0 = name.substr(0, 8);\r\n            res = GameRes.Prefab3D[name0].instance;\r\n            const index = name.substr(7, 1);\r\n            this.endRoadData['index' + index] = 1;\r\n        }\r\n        else if (name.substr(0, 11) === 'ZhangaiBian') {\r\n            const name0 = name.substr(0, 14);\r\n            if (GameData.Level.mode === GameEnum.LevelMode.common) {\r\n                this.colorIndex = +name.substr(13, 1);\r\n            }\r\n            else {\r\n                this.colorIndex = Math.floor(Math.random() * 3) + 1;\r\n            }\r\n            res = GameRes.Prefab3D[name0].instance;\r\n        }\r\n        else if (name.substr(0, 8) === 'RoadTied') {\r\n            res = GameRes.Prefab3D.RoadTied.instance;\r\n        }\r\n        else if (name.substr(0, 9) === 'Road_Base') {\r\n            res = GameRes.Prefab3D.Road_Base.instance;\r\n        }\r\n        else if (name.substr(0, 7) === 'KeyFood') {\r\n            res = GameRes.Prefab3D.KeyFood.instance;\r\n        }\r\n        else if (name.substr(0, 13) === 'zhangai_xiepo') {\r\n            res = GameRes.Prefab3D.zhangai_xiepo.instance;\r\n        }\r\n        else if (name.substr(0, 8) === 'zhangai0') {\r\n            const index = +name.substr(8, 1);\r\n            res = GameRes.Prefab3D[`zhangai0${index}`].instance;\r\n        }\r\n        else if (name.substr(0, 4) === 'drop') {\r\n            res = GameRes.Prefab3D.drop.instance;\r\n        }\r\n        return res;\r\n    }\r\n    setBubbleColorIndex() {\r\n        const colorArr = this.endRoadData.color.split('_');\r\n        let group = 0;\r\n        if (this.endRoadData.index1 && this.endRoadData.index2 && this.endRoadData.index3) {\r\n            group = 3;\r\n        }\r\n        else if (this.endRoadData.index1 && this.endRoadData.index2) {\r\n            group = 2;\r\n        }\r\n        else if (this.endRoadData.index1) {\r\n            group = 1;\r\n        }\r\n        if (colorArr.length === 1) {\r\n            if (group > 1) {\r\n                const ran = Math.floor(Math.random() * group) + 1;\r\n                this.endRoadData['index' + ran] = this.colorIndex;\r\n                for (let i = 0; i < 3; i++) {\r\n                    if (i !== ran) {\r\n                        this.endRoadData['index' + i] = Math.floor(Math.random() * 3) + 1;\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                this.endRoadData.index1 = this.colorIndex;\r\n            }\r\n        }\r\n        else {\r\n            for (let i = 0; i < colorArr.length; i++) {\r\n                const index = +colorArr[i];\r\n                if (index === 0) {\r\n                    this.endRoadData[`index${i + 1}`] = Math.floor(Math.random() * 3) + 1;\r\n                }\r\n                else {\r\n                    this.endRoadData[`index${i + 1}`] = index;\r\n                }\r\n            }\r\n        }\r\n    }\r\n    changeColor(bubble) {\r\n        if (bubble.name.substr(0, 6) === 'paopao') {\r\n            const group = +bubble.name.substr(7, 1);\r\n            const index0 = this.endRoadData[`index${group}`];\r\n            if (!GameRes.Material[`bubble0${index0}`]) {\r\n                console.log('不存在资源', `bubble0${index0}`);\r\n            }\r\n            else {\r\n                const bubble01 = bubble.getChildByName('pao01');\r\n                const bubble02 = bubble.getChildByName('pao02');\r\n                const mat = GameRes.Material['bubble0' + index0].instance;\r\n                bubble.colorIndex = index0;\r\n                const coe1 = 0.05;\r\n                const coe2 = 0.05;\r\n                const coe3 = 0.02;\r\n                var gradualChange = (arr) => {\r\n                };\r\n                if (index0 === 1) {\r\n                    gradualChange(this.redBase);\r\n                }\r\n                else if (index0 === 2) {\r\n                    gradualChange(this.yellowBase);\r\n                }\r\n                else if (index0 === 3) {\r\n                    gradualChange(this.blueBase);\r\n                }\r\n                bubble02.meshRenderer.material = bubble01.meshRenderer.material = mat;\r\n            }\r\n        }\r\n    }\r\n    ;\r\n    changeRodeColor(roadBase) {\r\n        if (roadBase.name.substr(0, 9) === 'Road_Base' || roadBase.name.substr(0, 9) === 'Road_888') {\r\n            if (GameData.Level.mode === GameEnum.LevelMode.endless) {\r\n                const base01 = roadBase.getChildByName('road_base_01');\r\n                if (base01) {\r\n                    const mat = base01.meshRenderer.material;\r\n                    mat.albedoColor = new Laya.Vector4(0.3, 0.18, 0.92, 1);\r\n                }\r\n            }\r\n        }\r\n    }\r\n    changeDoorColor(door) {\r\n        if (door['alreadyChange'] || GameData.Level.mode === GameEnum.LevelMode.common) {\r\n            return;\r\n        }\r\n        if (door.name.substr(0, 11) === 'ZhangaiBian') {\r\n            const position = door.transform.position.clone();\r\n            const parent = door.parent;\r\n            let newDoor;\r\n            const res = GameRes.Prefab3D['ZhangaiBian_0' + this.colorIndex];\r\n            if (!res) {\r\n            }\r\n            else {\r\n                newDoor = res.instance.clone();\r\n                newDoor['alreadyChange'] = true;\r\n                parent.addChild(newDoor);\r\n                newDoor.transform.position = position;\r\n                door.active = false;\r\n            }\r\n        }\r\n    }\r\n    RoadAdd() {\r\n        Laya.timer.frameLoop(1, this, () => {\r\n            if (this.endRoad && this.endRoad.transform) {\r\n                if (this.endRoad.transform.position.z - this.camaraPoint.transform.position.z < 100) {\r\n                    if (this.createRoad()) {\r\n                        if (this.roadIndex > 3) {\r\n                            const originalPos = this.endRoad.transform.position.clone();\r\n                            this.endRoad.transform.localPositionY = originalPos.y - 20;\r\n                            LwgAni3D.moveToY(this.endRoad, originalPos.y + 3, this.roadAddTime, this, null, () => {\r\n                                LwgAni3D.moveToY(this.endRoad, originalPos.y, this.roadAddTime / 2, this, null, () => {\r\n                                });\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            let dis = 0;\r\n            if (GameData.Level.mode === GameEnum.LevelMode.endless) {\r\n                dis = 0;\r\n            }\r\n            if (this.endMargin && this.endMargin.transform) {\r\n                if (this.camaraPoint.transform.position.z - this.endMargin.transform.position.z > dis) {\r\n                    this.createMargin();\r\n                }\r\n            }\r\n        });\r\n    }\r\n    RoadDestory() {\r\n        Laya.timer.frameLoop(10, this, () => {\r\n            if (this.roadIndex > 2) {\r\n                for (let i = 0; i < this.roadParent.numChildren; i++) {\r\n                    const Road = this.roadParent.getChildAt(i);\r\n                    if (Road.name !== 'Road_999' && Road.name !== 'Road_997') {\r\n                        if (this.camaraPoint.transform.localPositionZ - Road.transform.position.z > this.roadDestoryDistance) {\r\n                            Road.destroy(true);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            if (this.marginIndex > 2) {\r\n                if (this.marginParent.numChildren > 1) {\r\n                    for (let j = 0; j < this.marginParent.numChildren; j++) {\r\n                        const margin = this.marginParent.getChildAt(j);\r\n                        if (this.camaraPoint.transform.localPositionZ - margin.transform.position.z > 200) {\r\n                            margin.destroy(true);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    hideBase() {\r\n        LwgEvent.offAllCaller(this);\r\n        Laya.timer.clearAll(this);\r\n        LwgTools.Node.destroyAllChildren(this.marginParent);\r\n        LwgTools.Node.destroyAllChildren(this.roadParent);\r\n    }\r\n}\r\n",
  "references": [
    "E:/svn/泡泡/Bubble_Laya_2.9.0/Project/src/script/Lwg/Lwg.ts",
    "E:/svn/泡泡/Bubble_Laya_2.9.0/Project/src/script/Game/Control/GameData.ts",
    "E:/svn/泡泡/Bubble_Laya_2.9.0/Project/src/script/Game/Control/GameEnum.ts",
    "E:/svn/泡泡/Bubble_Laya_2.9.0/Project/src/script/Game/Control/GameEvent.ts",
    "E:/svn/泡泡/Bubble_Laya_2.9.0/Project/src/script/Game/Control/GameRes.ts",
    "E:/svn/泡泡/Bubble_Laya_2.9.0/Project/src/script/Game/Control/GameType.ts"
  ]
}
