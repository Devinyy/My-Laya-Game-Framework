{
  "code": "import { LwgAni3D, LwgEvent, LwgTools } from \"../../Lwg/Lwg\";\r\nimport { GameData } from \"../Control/GameData\";\r\nimport { GameEnum } from \"../Control/GameEnum\";\r\nimport { GameEvent } from \"../Control/GameEvent\";\r\nimport { GameRes } from \"../Control/GameRes\";\r\nexport class MainScene {\r\n    constructor() {\r\n        this.lenTotal = 0;\r\n        this._lenCur = 0;\r\n        this.endlessLvData = [];\r\n        this.proUnitLen = 'proUnitLen';\r\n        this.proIndex = 'proIndex';\r\n        MainScene.ins = this;\r\n        this.scene = GameRes.Scene3D.MainScene.instance;\r\n        Laya.stage.addChild(this.scene);\r\n        this.camaraPoint = this.scene.getChildByName('CameraPoint');\r\n        this.mainCamara = this.camaraPoint.getChildByName('Main Camera');\r\n        if (Laya.Browser.pixelRatio >= 16 / 9) {\r\n            this.mainCamara.fieldOfView += 5;\r\n        }\r\n        this.directionalLight = this.camaraPoint.getChildByName('Directional Light');\r\n        const mainCamaraP = this.mainCamara.transform.position;\r\n        this.mainCamaraFP = new Laya.Vector3(mainCamaraP.x, mainCamaraP.y, mainCamaraP.z);\r\n        this.unitParent = new Laya.Sprite3D;\r\n        this.unitParent.name = 'unitParent';\r\n        this.scene.addChild(this.unitParent);\r\n        this.road888 = this.scene.getChildByName('Road_888');\r\n        this.marginParent = new Laya.Sprite3D;\r\n        this.marginParent.name = 'marginParent';\r\n        this.scene.addChild(this.marginParent);\r\n        LwgEvent.register(GameEvent.changeBoss, this, (type) => {\r\n            return;\r\n            if (this.road999) {\r\n                const bossPoint = this.road999.getChildByName('BossPoint');\r\n                const oldSkin = bossPoint.getChildAt(0);\r\n                if (type == GameEnum.RoleType.vegan) {\r\n                    const newSkin = GameRes.Prefab3D.dino_215.instance.clone();\r\n                    bossPoint.addChild(newSkin);\r\n                    newSkin.transform.position = oldSkin.transform.position.clone();\r\n                    newSkin.transform.localRotationEuler = oldSkin.transform.localRotationEuler.clone();\r\n                    oldSkin.destroy();\r\n                    this.boss = newSkin;\r\n                }\r\n                else {\r\n                    this.boss = oldSkin;\r\n                }\r\n            }\r\n            for (let i = 0; i < this.unitParent.numChildren; i++) {\r\n                const unit = this.unitParent.getChildAt(i);\r\n                for (let j = 0; j < unit.numChildren; j++) {\r\n                    const child = unit.getChildAt(j);\r\n                    const childName = child.name;\r\n                    if (childName.substr(0, 4) == 'Food') {\r\n                        if (type == GameEnum.RoleType.vegan) {\r\n                            if (child.name.substr(0, 5) == 'FoodB') {\r\n                                const eff = GameRes.Prefab3D.effect_BadFood.instance.clone();\r\n                                child.addChild(eff);\r\n                                const middle = child.getChildByName('middle');\r\n                                if (middle) {\r\n                                    const model = child.getChildByName('middle').getChildAt(0);\r\n                                    const mat = model.meshRenderer.material;\r\n                                    mat.albedoColor = new Laya.Vector4(0.5, 0.5, 0.5, 1);\r\n                                }\r\n                                else {\r\n                                    console.log(unit.name, child.name, '不存在middle');\r\n                                }\r\n                            }\r\n                        }\r\n                        else if (type == GameEnum.RoleType.meat) {\r\n                            if (child.name.substr(0, 5) == 'FoodA') {\r\n                                const eff = GameRes.Prefab3D.effect_BadFood.instance.clone();\r\n                                child.addChild(eff);\r\n                                const middle = child.getChildByName('middle');\r\n                                if (middle) {\r\n                                    const model = child.getChildByName('middle').getChildAt(0);\r\n                                    const mat = model.meshRenderer.material;\r\n                                    mat.albedoColor = new Laya.Vector4(0.5, 0.5, 0.5, 1);\r\n                                }\r\n                                else {\r\n                                    console.log(unit.name, child.name, '不存在middle');\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    get lenCur() {\r\n        return this._lenCur;\r\n    }\r\n    set lenCur(val) {\r\n        this._lenCur = val;\r\n        if (this._lenCur > this.lenTotal) {\r\n            this._lenCur = this.lenTotal;\r\n        }\r\n        LwgEvent.notify(GameEvent.updateLvSchedule, [this._lenCur / this.lenTotal]);\r\n    }\r\n    ready() {\r\n        Laya.timer.clearAll(this);\r\n        this.lenTotal = 0;\r\n        this.lenCur = 0;\r\n        this.road888.active = true;\r\n    }\r\n    start(mode) {\r\n        if (mode === GameEnum.LevelMode.common) {\r\n            this.setUnitByData();\r\n            this.unitDisplay(2, 2);\r\n            this.setMargin();\r\n        }\r\n        else {\r\n            this.creatStartUnit();\r\n            this.unitDynamicallyAdd();\r\n            this.endlessUnitDestory();\r\n        }\r\n    }\r\n    creatStartUnit() {\r\n        LwgTools.Node.destroyAllChildren(this.unitParent);\r\n        const dataArr = GameData.Level.getEndlessLvData();\r\n        this.endlessLvFoodName = GameData.Level.getEndlessLvFood();\r\n        console.log(this.endlessLvFoodName);\r\n        this.endlessLvData = dataArr;\r\n        for (let index = 0; index < 2; index++) {\r\n            const unitObj = dataArr[index];\r\n            this.endUnit = GameRes.Prefab3D[unitObj.name].instance.clone();\r\n            this.unitParent.addChild(this.endUnit);\r\n            this.endUnit.transform.position = new Laya.Vector3(0, 0, this.lenTotal);\r\n            this.changeFoodEndless();\r\n            this.lenTotal += unitObj.length;\r\n            this.unitIndex = index;\r\n        }\r\n        LwgTools.Node.destroyAllChildren(this.marginParent);\r\n        for (let index = -2; index < 2; index++) {\r\n            const margin = GameRes.Prefab3D.margin.instance.clone();\r\n            this.marginParent.addChild(margin);\r\n            margin.transform.position = new Laya.Vector3(0, 0, index * 200);\r\n        }\r\n    }\r\n    unitDynamicallyAdd() {\r\n        Laya.timer.frameLoop(30, this, () => {\r\n            if (this.endUnit) {\r\n                if (this.endUnit.transform.position.z - this.camaraPoint.transform.position.z < 50) {\r\n                    const unitObj = this.endlessLvData[this.unitIndex];\r\n                    if (unitObj) {\r\n                        this.endUnit = GameRes.Prefab3D[unitObj.name].instance.clone();\r\n                        this.unitParent.addChild(this.endUnit);\r\n                        this.endUnit.transform.position = new Laya.Vector3(0, 0, this.lenTotal);\r\n                        this.changeFoodEndless();\r\n                        this.lenTotal += unitObj.length;\r\n                        this.unitIndex++;\r\n                        console.log(unitObj.name);\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n    changeFoodEndless() {\r\n        for (let index = 0; index < this.endUnit.numChildren; index++) {\r\n            const child = this.endUnit.getChildAt(index);\r\n            if (child['newFood']) {\r\n                continue;\r\n            }\r\n            let newFood;\r\n            if (child.name.substr(0, 5) === 'FoodB' || child.name.substr(0, 5) === 'FoodA') {\r\n                newFood = GameRes.Prefab3D[this.endlessLvFoodName].instance.clone();\r\n                this.endUnit.addChild(newFood);\r\n                newFood.transform.position = child.transform.position.clone();\r\n                newFood['newFood'] = true;\r\n                child.active = false;\r\n            }\r\n        }\r\n    }\r\n    endlessUnitDestory() {\r\n        Laya.timer.frameLoop(1, this, () => {\r\n            for (let index = 0; index < this.unitParent.numChildren; index++) {\r\n                const unit = this.unitParent.getChildAt(index);\r\n                if (this.camaraPoint.transform.localPositionZ - unit.transform.position.z > 80) {\r\n                    unit.destroy(true);\r\n                }\r\n            }\r\n        });\r\n    }\r\n    setUnitByData() {\r\n        LwgTools.Node.destroyAllChildren(this.unitParent);\r\n        const dataArr = GameData.Level.getUnitDataArr();\r\n        const fAIndex = GameData.Level.getFoodAType();\r\n        const fBIndex = GameData.Level.getFoodBType();\r\n        for (let index = 0; index < dataArr.length; index++) {\r\n            let unit;\r\n            const unitObj = dataArr[index];\r\n            if (GameRes.Prefab3D[unitObj.name] && GameRes.Prefab3D[unitObj.name].instance) {\r\n                unit = GameRes.Prefab3D[unitObj.name].instance.clone();\r\n                unit[this.proUnitLen] = unitObj.length;\r\n                unit[this.proIndex] = index;\r\n                this.unitParent.addChild(unit);\r\n                unit.transform.position = new Laya.Vector3(0, 0, this.lenTotal);\r\n                if (unitObj.name !== 'unit_999') {\r\n                    this.lenTotal += unitObj.length;\r\n                }\r\n                else {\r\n                    this.road999 = unit;\r\n                }\r\n                unit.active = false;\r\n                for (let index = 0; index < unit.numChildren; index++) {\r\n                    const child = unit.getChildAt(index);\r\n                    if (child['newFood']) {\r\n                        continue;\r\n                    }\r\n                    if (child.name.substr(0, 4) === 'Food') {\r\n                        this.changeFood(child, fAIndex, fBIndex, unit);\r\n                    }\r\n                }\r\n            }\r\n            else {\r\n                console.log('路段', unitObj, '不存在！');\r\n                continue;\r\n            }\r\n        }\r\n    }\r\n    changeFood(food, fAIndex, fBIndex, unit) {\r\n        let newFood;\r\n        if (food.name.substr(0, 5) === 'FoodA') {\r\n            newFood = GameRes.Prefab3D['FoodA0' + fAIndex].instance.clone();\r\n        }\r\n        if (food.name.substr(0, 5) === 'FoodB') {\r\n            newFood = GameRes.Prefab3D['FoodB0' + fBIndex].instance.clone();\r\n        }\r\n        unit.addChild(newFood);\r\n        newFood.transform.position = food.transform.position.clone();\r\n        newFood['newFood'] = true;\r\n        food.active = false;\r\n    }\r\n    setMargin() {\r\n        LwgTools.Node.destroyAllChildren(this.marginParent);\r\n        let num = Math.round(200 / this.lenTotal);\r\n        if (num < 1) {\r\n            num = 1;\r\n        }\r\n        num += 1;\r\n        for (let index = -2; index < num; index++) {\r\n            const margin = GameRes.Prefab3D.margin.instance.clone();\r\n            this.marginParent.addChild(margin);\r\n            margin.transform.position = new Laya.Vector3(0, 0, index * 200);\r\n        }\r\n    }\r\n    unitDisplay(numShow = 2, numHide = 0.5) {\r\n        Laya.timer.frameLoop(1, this, () => {\r\n            if (this.road888.transform.position.z + 20 < this.camaraPoint.transform.localPositionZ) {\r\n                if (this.road888.active) {\r\n                    this.road888.active = false;\r\n                }\r\n            }\r\n            for (let index = 0; index < this.unitParent.numChildren; index++) {\r\n                const unit = this.unitParent.getChildAt(index);\r\n                if (unit.transform.position.z < this.camaraPoint.transform.localPositionZ) {\r\n                    if (this.camaraPoint.transform.localPositionZ - unit.transform.position.z > numHide * unit[this.proUnitLen]) {\r\n                        if (unit.active) {\r\n                            if (unit.name !== 'Road999') {\r\n                                unit.active = false;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                else {\r\n                    if (unit.transform.position.z - this.camaraPoint.transform.localPositionZ <= unit[this.proUnitLen] * numShow) {\r\n                        const front = this.unitParent.getChildAt(unit[this.proIndex] - 1);\r\n                        if (front && !front.active) {\r\n                            return;\r\n                        }\r\n                        if (!unit.active) {\r\n                            unit.active = true;\r\n                            if (index !== 0) {\r\n                                const pos = unit.transform.position.clone();\r\n                                unit.transform.position = new Laya.Vector3(pos.x, pos.y - 20, pos.z);\r\n                                LwgAni3D.moveTo(unit, pos, 500, this, Laya.Ease.backInOut);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        });\r\n    }\r\n}\r\n",
  "references": [
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/ui/layaMaxUI.ts",
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/script/Lwg/Lwg.ts",
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/script/Game/Control/GameData.ts",
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/script/Game/Control/GameEnum.ts",
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/script/Game/Control/GameEvent.ts",
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/script/Game/Control/GameRes.ts",
    "E:/svn/恐龙跑酷/DinosaursGrow_Laya_2.9.0/DinosaursGrowUp_2.9.0/src/script/Game/Control/GameType.ts"
  ]
}
